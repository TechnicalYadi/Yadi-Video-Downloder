<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Terminal-style Video Downloader</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#071013;
      --panel:#0b1a1c;
      --text:#d9f8ef;
      --muted:#93b5ae;
      --accent:#5fe0c6;
      --button:#1a8f87;
      --danger:#ff7b7b;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family: "Segoe UI", Roboto, "Courier New", monospace;color:var(--text);}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    header{display:flex;align-items:center;gap:14px}
    .logo{
      width:56px;height:56px;border-radius:8px;background:#052323;display:flex;align-items:center;justify-content:center;
      font-weight:700;color:var(--accent);font-family:monospace;font-size:18px;
      border:1px solid rgba(95,224,198,0.08);
    }
    h1{margin:0;font-size:20px;color:var(--accent)}
    p.lead{margin:4px 0 0;color:var(--muted);font-size:13px}

    .grid{display:grid;grid-template-columns:420px 1fr;gap:18px;margin-top:18px}
    .panel{background:var(--panel);border-radius:8px;padding:14px;border:1px solid rgba(255,255,255,0.03)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}

    .input, select {
      width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.04);
      background:transparent;color:var(--text);font-size:14px;box-sizing:border-box;
    }

    .row{display:flex;gap:8px;align-items:center}
    .btn {
      padding:10px 14px;border-radius:6px;border:none;background:var(--button);color:#042f2c;font-weight:700;cursor:pointer;
      font-size:14px;
    }
    .btn.secondary{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.03)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px}

    /* terminal/log area */
    .terminal{
      background:#071b1c;color:var(--text);padding:12px;border-radius:6px;height:420px;overflow:auto;font-size:13px;
      line-height:1.45;border:1px solid rgba(255,255,255,0.02);
    }
    .log-line{white-space:pre-wrap;margin:6px 0}
    .log-info{color:var(--muted)}
    .log-ok{color:var(--accent)}
    .log-err{color:var(--danger)}

    .meta{margin-top:12px}
    .meta div{display:flex;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;font-size:13px;color:var(--muted)}

    .progress-wrap{margin-top:12px}
    .progress-bar{width:100%;height:14px;background:#053333;border-radius:8px;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
    .progress-inner{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#4bd3c0);transition:width .25s}

    footer{margin-top:18px;font-size:12px;color:var(--muted)}
    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">YADI</div>
      <div>
        <h1><u><i>YADI </i></u>  STYLE VIDEO DOWNLODER</h1>
        <p class="lead">Flask • yt-dlp • FFmpeg — educational & ethical use only</p>
      </div>
    </header>

    <div class="grid">
      <!-- controls -->
      <div class="panel">
        <label for="url">Video URL (YouTube / Hotstar)</label>
        <div class="row">
          <input id="url" class="input" placeholder="Paste video URL..." />
          <button id="checkBtn" class="btn">Check</button>
        </div>
        <div class="hint">For Hotstar premium content: upload cookies (Netscape) below or keep cookie file in server path.</div>

        <div style="margin-top:12px">
          <label for="cookiesInput">Upload cookies.txt (optional)</label>
          <div class="row">
            <input type="file" id="cookiesInput" accept=".txt" style="flex:1" />
            <button id="uploadCookies" class="btn secondary">Upload</button>
          </div>
        </div>

        <div class="meta" aria-live="polite">
          <div><span class="muted">Title</span><strong id="metaTitle">—</strong></div>
          <div><span class="muted">Duration</span><strong id="metaDuration">—</strong></div>
          <div><span class="muted">Estimated size</span><strong id="metaSize">—</strong></div>
        </div>

        <div style="margin-top:12px">
          <label for="qualitySelect">Select quality</label>
          <select id="qualitySelect"></select>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button id="downloadBtn" class="btn">Download</button>
          <button id="clearBtn" class="btn secondary">Clear</button>
        </div>

        <div class="progress-wrap">
          <div class="progress-bar"><div id="bar" class="progress-inner"></div></div>
          <div id="status" style="margin-top:8px;color:var(--muted)">Idle</div>
        </div>

        <footer>
          <div>Note: Do not upload or share copyrighted content. Cookies are used only for authentication and are not stored permanently.</div>
        </footer>
      </div>

      <!-- logs -->
      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="color:var(--muted)">Activity log</div>
          <div style="font-size:12px;color:var(--muted)">Local • Dev Mode</div>
        </div>

        <div id="terminal" class="terminal" aria-live="polite" role="log">
          <div class="log-line log-ok">[init] Ready. Paste URL and press Check.</div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="copyLog" class="btn secondary">Copy log</button>
          <button id="openDownloads" class="btn secondary">Show downloads (manual)</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // simple logger
    function log(msg, cls='log-info'){
      const t = document.getElementById('terminal');
      const el = document.createElement('div');
      el.className = 'log-line ' + cls;
      el.textContent = msg;
      t.appendChild(el);
      t.scrollTop = t.scrollHeight;
    }

    // buttons
    document.getElementById('checkBtn').addEventListener('click', async () => {
      const url = document.getElementById('url').value.trim();
      if(!url){ log('[error] No URL provided', 'log-err'); return; }
      log(`[info] Checking: ${url}`, 'log-info');

      const fd = new FormData();
      fd.append('url', url);
      const f = document.getElementById('cookiesInput').files[0];
      if(f) fd.append('cookies', f);

      try{
        const res = await fetch('/info', { method:'POST', body: fd });
        const data = await res.json();
        if(data.error){ log('[error] ' + data.error, 'log-err'); return; }
        log('[ok] Info loaded', 'log-ok');
        document.getElementById('metaTitle').textContent = data.title || '—';
        document.getElementById('metaDuration').textContent = (data.duration || '?') + ' min';
        // populate quality
        const sel = document.getElementById('qualitySelect');
        sel.innerHTML = '';
        (data.formats || []).forEach(f => {
          const opt = document.createElement('option');
          opt.value = f.id;
          opt.text = `${f.res} • ${f.size} • ${f.ext}`;
          sel.add(opt);
        });
        if((data.formats || []).length === 0){
          sel.innerHTML = '<option value="best">best</option>';
        }
      }catch(err){
        log('[error] Network or server issue: ' + err.message, 'log-err');
      }
    });

    document.getElementById('uploadCookies').addEventListener('click', () => {
      const f = document.getElementById('cookiesInput').files[0];
      if(!f){ log('[warn] No cookies file chosen', 'log-info'); return; }
      log('[ok] Cookies file selected: ' + f.name, 'log-ok');
    });

    document.getElementById('downloadBtn').addEventListener('click', async () => {
      const url = document.getElementById('url').value.trim();
      const format_id = document.getElementById('qualitySelect').value || 'best';
      if(!url){ log('[error] No URL', 'log-err'); return; }
      log(`[start] Download requested (${format_id})`, 'log-info');

      const fd = new FormData();
      fd.append('url', url);
      fd.append('format_id', format_id);
      const f = document.getElementById('cookiesInput').files[0];
      if(f) fd.append('cookies', f);

      try{
        await fetch('/download', { method:'POST', body: fd });
        log('[ok] Download started', 'log-ok');
        document.getElementById('status').textContent = 'Downloading...';
        startPolling();
      }catch(e){
        log('[error] Failed to start download: ' + e.message, 'log-err');
      }
    });

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      document.getElementById('url').value = '';
      document.getElementById('qualitySelect').innerHTML = '';
      document.getElementById('metaTitle').textContent = '—';
      document.getElementById('metaDuration').textContent = '—';
      document.getElementById('metaSize').textContent = '—';
      log('[action] UI cleared', 'log-info');
    });

    document.getElementById('copyLog').addEventListener('click', async ()=>{
      const lines = Array.from(document.querySelectorAll('#terminal .log-line')).map(n=>n.textContent).join('\n');
      try{
        await navigator.clipboard.writeText(lines);
        log('[ok] Log copied to clipboard', 'log-ok');
      }catch(e){
        log('[warn] Clipboard not available: ' + e.message, 'log-info');
      }
    });

    document.getElementById('openDownloads').addEventListener('click', ()=>{
      log('[info] Open the "downloads/" folder in your project directory to access files', 'log-info');
    });

    // progress polling and update
    let pollInterval = null;
    function startPolling(){
      if(pollInterval) return;
      pollInterval = setInterval(async ()=>{
        try{
          const res = await fetch('/progress');
          const d = await res.json();
          const pct = d.progress || '0%';
          const w = pct.toString().replace('%','');
          document.getElementById('bar').style.width = (isNaN(Number(w)) ? 0 : Number(w)) + '%';
          document.getElementById('status').textContent = `Status: ${d.status || ''} | ${pct} | Speed: ${d.speed || ''} | ETA: ${d.eta || ''}`;
          log(`[prog] ${pct} • ${d.speed || '0 KB/s'} • ETA ${d.eta || 'N/A'}`, 'log-info');
          if((d.status||'').startsWith('done') || (d.status||'').startsWith('error')){
            clearInterval(pollInterval);
            pollInterval = null;
            if((d.status||'').startsWith('error')) log('[error] ' + (d.status || 'unknown error'), 'log-err');
            else log('[ok] Download finished', 'log-ok');
          }
        }catch(e){
          log('[error] Progress polling failed: ' + e.message, 'log-err');
        }
      }, 1200);
    }
  </script>

  <!-- reuse existing progress.js if present (it will still work); otherwise this UI polls itself -->
  <script>
    // load progress.js if available at the static path (optional)
    (function(){
      const s = document.createElement('script');
      s.src = "{{ url_for('static', filename='progress.js') }}";
      s.async = true;
      document.head.appendChild(s);
    })();
  </script>
</body>
</html>
